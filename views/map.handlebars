<!doctype html>
<html>
<head>
    <title>tritonPARK :: locator</title>  
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="images/favicon.png">
    

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->        
    
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="js/bootstrap.js"></script>
    <script type="text/javascript" src="js/bootstrap-slider.js"></script>
    <script type="text/javascript" src="js/offcanvas.js"></script>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
    <script type="text/javascript" src="js/gmaps.js"></script>
    <link rel="stylesheet" type="text/css" href="css/bootstrap.css"/>     
    <link rel="stylesheet" type="text/css" href="css/offcanvas.css"/>
    <link rel="stylesheet" type="text/css" href="css/slider.css"/>
    <style>
    .popup_content
    {
        color: #000 !important;
    }
    </style>
    <script type="text/javascript">
        var userHOUR = 8; //global var so that all objects can access current hour. Initial to 8 am so we dont face NULL problems.
        var userCOORDS;
        var userLAT;
        var userLON;
        var map;
        var userPERMIT = 'S';

        $(document).ready(function()
        {
            map = new GMaps(
            {
                el: '#map',
                lat: 32.8810,
                lng: -117.2380,
                zoom: 15
            });
            setupMap();
        });
        
    </script>
</head>
    
<body>
    
    <!-- TOP NAVIGATION BAR -->

    <div class="navbar navbar-default  navbar-fixed-top" role="navigation">
      <div class="container">          
        <div class="navbar-header">
        
        <button type="button" class="navbar-toggle btn btn-primary btn-xs" data-toggle="offcanvas">
            <span class="glyphicon glyphicon-list"></span>
            
        </button>
        <button type="button" class="navbar-toggle btn btn-primary btn-xs" data-toggle="modal" data-target="#myModal">
        <span class="glyphicon glyphicon-map-marker"></span>
        </button>
          <a class="navbar-brand" href="/">tritonPARK</a>
        </div> 
      </div>
    </div>

        <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title" id="myModalLabel">Leaving Spot Open</h4>
          </div>
          <div class="modal-body">
             <form class="form-inline" onsubmit="doSomething()">
                                <input id="spotinfo" class="form-control" type="text" placeholder="Spot Comments" />
                                
                                </form>
          </div>
          <div class="modal-footer">
            
            <button type="submit" class="btn btn-primary pull-right" onclick="doSomething()">Open Spot Here!</button>
          </div>
        </div>
      </div>
    </div>
    
    

   <div class="container">
        <div class="row row-offcanvas row-offcanvas-right">
            <div class="col-xs-12 col-sm-9">
                <div id="map" style="height: 500px; background-color:#000;"></div>
            </div>
          
            <div class="col-xs-6 col-sm-3 sidebar-offcanvas" id="sidebar" role="navigation">
            <h4>Permit Type:</h4>
              <div class="list-group">
                
                <a href="#" class="list-group-item active" onclick="setPermitType('S')">Student (S)</a>
                <a href="#" class="list-group-item" onclick="setPermitType('B')">Graudate (B)</a>
                <a href="#" class="list-group-item" onclick="setPermitType('A')">Faculty (A)</a>
                <a href="#" class="list-group-item" onclick="setPermitType('V')">Visitor (V)</a>
              </div>
              
            </div><!--/span-->

            
        </div><!--/row-->
        <hr />

<div class="row container"><div class="well">
                    
                    Time to Park:
                        <br>
                    <input type="text" class="slider" value="8:00AM" id="sl1" data-slider-min="8" data-slider-max="17" data-slider-handle="round" width="25">
                    <p id="updateme">Current: 8:00 am</p>
                </div></div>
                
                
                

    </div><!--/.container-->
    </center>
<script type="text/javascript">
$('.slider').slider(
{
  formater: function(value)
  {
     hour = value;
     userHOUR = value;
    var ampm = 'am';
    if(value > 12)
    {
        hour = value -12;
        ampm = 'pm';
    }
    if(value ==12)
    {
        ampm = 'pm'
    }
    return 'Current Time: '+hour + ':00 '+ampm;
  }
})
  .on('slideStop', function(ev){
            hour = ev.value;
            var ampm = 'am';

            if(ev.value > 12)
            {
                hour = ev.value -12;
                ampm = 'pm';
            }
                if(ev.value ==12)
    {
        ampm = 'pm'
    }
    document.getElementById("updateme").innerHTML = "Currently Selected Time: " + hour + ":00 "+ampm;
  });</script>
    <script type="text/javascript">

    var socket = io.connect();
      //$('#openparking').submit(function()
      function doSomething()
      {
        initiateGeoLocation();
        var myObject =
        {
            message: $('#spotinfo').val(),
            lat: userLAT,
            lon: userLON
        }
        socket.emit('realtime', myObject);
        $('#spotinfo').val('');
        $('#myModal').modal('hide')
        return false;
      };

      socket.on('realtime', function(msg)
      {
        map.addMarker(
            {
                lat: msg.lat, 
                lng: msg.lon,
                title: msg.message,
                icon  : 'http://maps.google.com/mapfiles/kml/paddle/ylw-stars.png',
                infoWindow:
                {
                    content: '<p class="popup_content" style="width:100px; height: 100px; overflow: hidden;" id="hopkinIW">'+msg.message+'</p>'
                }
            });
      });
   var initiateGeoLocation = function() {
        navigator.geolocation.getCurrentPosition(setNewCoordinates, null, {
            enableHighAccuracy: true,
            maximumAge: 0
        });
    };
    var setNewCoordinates = function(pos)
    {
        userCOORDS = pos.coords;
        userLAT = (Math.floor(userCOORDS.latitude*10000000)/10000000);
        userLON =  (Math.floor(userCOORDS.longitude*10000000)/10000000);
    };

    var setPermitType = function(permitType)
    {
        userPERMIT = permitType;
    }

    var regenerateMarkers = function()
    {
        map.removeMarkers();
        setupMap();
    }
    $('.list-group-item').on('click',function(e){
    var previous = $(this).closest(".list-group").children(".active");
    previous.removeClass('active'); // previous list-item
    $(e.target).addClass('active'); // activated list-item
  });
    setInterval(regenerateMarkers, 60*1000 );

    $(document).ready(initiateGeoLocation());

    function setupMap()
    {
      var jqxhr = $.getJSON( "/geo", function(){})
      .done(function(data)
      {
        for(var i =0; i<17; i++)
        {

          map.addMarker(
          {
              lat: data[i].LAT, 
              lng: data[i].LON,
              title: data[i].LOT,
              icon  : 'http://maps.google.com/mapfiles/kml/paddle/wht-blank.png',
              details:
              {
                LOT: data[i].LOT
              },
              infoWindow:
              {
                  content: '<p class="popup_content" style="width:200px; height: 200px; overflow: hidden;" id="'+data[i].LOT+'IW">'+data[i].LOT+'</p>'
              },
              click: function(e)
              {
                  
                  var ourLOT = e.details.LOT
                  $.getJSON( "projected/"+ourLOT+"/"+userPERMIT+"/"+userHOUR, function(data)
                  {
                   
                  })
                    .done(function(data)
                    {
                      var LOT = e.details.LOT;
                      var AVG = data[0].AVG;
                     document.getElementById(LOT+"IW").innerHTML = '<center><h3>'+LOT+'</h3></center><hr /><center><h5> predicted open: <h2>'+AVG+'</h2></center>';
                    });
              }
          });    
        }
      });
    };
    </script>


</body>
</html>